# A.I.VOICE & VOICEVOX Discord Bot

本ソフトウェアは、**A.I.VOICE Editor** および **VOICEVOX** と連携し、感情表現を含む音声読み上げ機能を提供する **Discord Bot** です。
Rustによる高速な音声処理、Ruffによる高品質なコード管理、そしてディレクトリ管理された拡張性の高いキャラクターシステムを備えています。
アラーム、タイマー、辞書登録といったユーティリティ機能を標準搭載しているほか、ローカル LLM を連携させれば対話Botとしても機能します。

---

## 概要

本システムは、ユーザーの好みに応じて **2つの音声合成エンジン** を切り替えて使用できます。
LLM 使用時は、テキスト内の感情タグ（例: `[JOY]`, `[SAD]`）を解析し、エンジンの機能を最大限に活かした感情表現を行います。

* **A.I.VOICE (Editor連携)**: 起動中の Editor を直接制御し、プリセット切替による自然な感情表現を行います。
* **VOICEVOX (HTTP連携)**: ローカル API を介して高速に音声を生成し、ピッチや抑揚のパラメータ操作で感情を表現します。

---

## 主な機能

### 起動ウィザード機能
起動時にランチャー (`start.bat`) を実行すると、対話形式で以下の設定を柔軟に行えるようになりました。
1. **TTSエンジンの選択** (A.I.VOICE / VOICEVOX)
2. **自動起動 & 接続待機** (設定されたパスからエンジンを自動起動し、APIが応答するまで待機します)
3. **TTSモデルの選択** (階層型メニューにより、A.I.VOICEのプリセットやVOICEVOXのスタイルを直感的に選択可能)
4. **キャラクター設定の読み込み** (`characters/` フォルダ内の構成済みデータをロードし、人格やセリフ設定を適用します)

### 音声処理
* **Rust バックエンド**: 音声のトリミング、増幅、リバーブ処理、Discord形式への変換を Rust (`rust_core`) で実装し、Python 単体時と比べて大幅な高速化と安定化を実現しました。

### 高度なキャラクター管理システム
* **個別設定フォルダ**: `characters` フォルダ内でキャラクターごとにディレクトリを分けて管理できます。
* **カスタムレスポンス**: キャラクターごとにシステムメッセージ（時報、挨拶、エラーなど）を JSON で個別に定義・上書き可能です。

### ユーティリティ機能（LLM不要）
LLMを導入しない場合でも、以下の機能は単体で動作します。
* アラーム / タイマー機能
* 辞書登録機能（読み間違いの修正）
* ダイスロール機能

### LLM ベースの対話機能（オプション）
ローカル LLM（LM Studio 等）を連携させると、事前定義された人格設定に基づいた対話が可能になります。
文脈に合わせて、Bot が自発的に感情タグを付与し、声色を変えて返答します。

---

## 動作環境

* OS: Windows 10 / 11 (64bit)
* Python: 3.10 以上
* Rust: (ビルド時のみ必要。利用者は同梱のビルド済みライブラリを使用可能)
* **必須ソフトウェア (使用するエンジンに合わせて用意):**
    * **A.I.VOICE Editor** (Ver.1 推奨 / Ver.2 も設定可)
    * **VOICEVOX**

※ **ローカルLLM（LM Studio等）は必須ではありません。** 会話機能を使いたい場合のみご用意ください。

---

## 導入手順

### Step 1. リポジトリのクローン

```bash
git clone https://github.com/Shise-mix/TTS-Discord-Bot.git
cd TTS-DiscordBot
```

### Step 2. インストール

環境に合わせて、以下のいずれかの方法でインストールを行ってください。

#### 方法A：簡単インストール（推奨）

同梱されている **`install.bat`** をダブルクリックして実行してください。
自動的に仮想環境 (`.venv`) が作成され、必要なライブラリ（Rust拡張含む）がインストールされます。

#### 方法B：手動インストール

コマンドラインから手動でセットアップを行う場合は、以下のコマンドを順に実行してください。

```bash
# 1. 仮想環境の作成
python -m venv .venv

# 2. 仮想環境の有効化 (Windows cmd)
.venv\Scripts\activate

# 3. ライブラリのインストール
pip install -r requirements.txt

# 4. Rust拡張モジュールのビルドとインストール (高速化のため --release 推奨)
maturin develop -m rust_core/Cargo.toml --release
```

### Step 3. 設定ファイルの作成 (.env)

Botのトークンやパスを設定するファイルを作成します。

1. 同梱の **`.env.example`** をコピーし、ファイル名を **`.env`** に変更します。
2. 作成した `.env` ファイルをテキストエディタで開き、以下の項目を設定して保存してください。

**ポイント:** `APP_PATH` を設定しておくと、Bot起動時にTTSソフトを自動的に起動できます。

```properties
# Discord Developer Portal から取得したトークンを設定
DISCORD_TOKEN=your_token_here

# LLMを使用する場合のAPIキー (チャット機能を使わない場合はそのままでOK)
LLM_API_KEY=lm-studio

# --- A.I.VOICE 設定 ---
AIVOICE_DLL_PATH=C:\Program Files\AI\AIVoice\AIVoiceEditor\AI.Talk.Editor.Api.dll
# 自動起動用の実行ファイルパス
AIVOICE_APP_PATH=C:\Program Files\AI\AIVoice\AIVoiceEditor\AIVoiceEditor.exe

# --- VOICEVOX 設定 ---
VOICEVOX_URL=http://127.0.0.1:50021
VOICEVOX_SPEAKER_ID=3
# 自動起動用の実行ファイルパス (環境に合わせて書き換えてください)
VOICEVOX_APP_PATH=C:\Users\Username\AppData\Local\Programs\VOICEVOX\VOICEVOX.exe
```

### Step 4. キャラクター設定 (charactersフォルダ)

Botの性格（プロンプト）や、システム音声（「時間だよ」等のセリフ）を設定します。
`characters` フォルダの中に、キャラクターごとのサブフォルダを作成して管理します。

**フォルダ構成例:**
```text
characters/
  ├─ akari/              <-- 任意のフォルダ名
  │   ├─ prompt.txt      <-- 人格プロンプト (ファイル名は自由)
  │   └─ responses.json  <-- セリフ設定JSON (ファイル名は自由)
  └─ zundamon/
      ├─ system.txt
      └─ config.json
```

**1. プロンプトファイル (.txt)**
LLMに対するシステム命令を記述します。
```text
命令：あなたは実在する少女「紲星あかり」になりきって振る舞ってください。
語尾には「〜だよ」「〜だね」をつけて話してください。
```

**2. レスポンスファイル (.json)**
Botの定型文（時報やエラーメッセージなど）をキャラクター口調に上書きするためのファイルです。
`settings.py` 内の `DEFAULT_RESPONSES` にあるキーを指定して上書きできます。

```json
{
    "join_greet_first": [
        "やっほー！待ってたよ！[JOY]",
        "遅いよー！寂しかったんだから！[SAD]"
    ],
    "alarm_notify_voice": [
        "時間だよー！起きてー！[JOY]"
    ]
}
```

---

## エンジン別の事前準備

### A.I.VOICE を使う場合

Bot の感情表現機能を最大限に活かすため、**A.I.VOICE Editor 上で以下のルールに従ってボイスプリセットを作成・保存してください。**

**プリセット命名規則:** `[標準名]_[感情タグ]`

| プリセット名 | 用途 |
|---|---|
| **[標準名]_NORMAL** | 通常会話 （例：`紲星 あかり_NORMAL`） |
| **[標準名]_JOY** | 喜び （例：`紲星 あかり_JOY`） |
| **[標準名]_SAD** | 悲しみ （例：`紲星 あかり_SAD`） |
| **[標準名]_ANGRY** | 怒り （例：`紲星 あかり_ANGRY`） |
| **[標準名]_SURPRISE** | 驚き （例：`紲星 あかり_SURPRISE`） |

**注意:** アンダーバーより前の部分は、Editor 上のキャラクター名（スペース含む）と完全に一致させてください。

### VOICEVOX を使う場合

特別なプリセット作成は不要です。
VOICEVOX ソフトが起動している（デフォルトポート `50021`）だけで利用可能です。
キャラクター選択画面では、自動的に「キャラクター名 → スタイル」の2段階で選択できるため、プリセット数が多くても快適に操作できます。

---

## 使用方法

### 1. Bot の起動
`start.bat` をダブルクリックします。

### 2. 起動ウィザードでの設定
コンソール画面で対話形式のウィザードが始まります。番号を入力して進めてください。

1.  **エンジンの選択**: 使用するTTSエンジン（A.I.VOICE / VOICEVOX）を選択します。
2.  **自動起動待機**: エンジンが未起動の場合、設定されたパスから自動起動し、APIが利用可能になるまで待機します。
3.  **キャラクター(TTS)の選択**:
    * A.I.VOICE: プリセット一覧から選択します。
    * VOICEVOX: まずキャラクター名を選び、次にスタイル（ノーマル、あまあま等）を選択します。
4.  **人格設定の選択**: `characters` フォルダ内のサブフォルダ一覧が表示されます。使用したい設定フォルダを選択してください。

### 3. 会話機能の使い方 (LLM利用時)
Bot と会話をする際は、**必ずメンション（@Bot名）** を付けるか、Bot のメッセージに **返信** してください。
※ 独り言や他のメンバーとの会話に反応しない仕様になっています。

> **Note**
> LLM サーバーを起動していない場合、会話機能（メンションへの返答）は機能しませんが、コマンド操作やアラーム機能は問題なく利用できます。

---

## 主要コマンド一覧

| コマンド | 機能 |
|---|---|
| `/join` | Botをボイスチャンネルに接続（移動も可能） |
| `/bye` | 切断 |
| `/char [名前]` | TTS音声キャラクターの変更 |
| `/presets` | 利用可能なTTSプリセット一覧 |
| `/stop` | 読み上げ停止 |
| `/alarm add` | アラーム設定 |
| `/dict add` | 辞書登録 |
| `/dice` | ダイスロール |
| `/reset` | LLMとの会話履歴をリセット |

---

## 開発者向け情報

本プロジェクトはコード品質向上のため **Ruff** を採用しています。
開発に参加される場合は、以下のコマンドでフォーマットとLintチェックを行ってください。

```bash
ruff check .
ruff format .
```

## ライセンス

MIT License

各音声合成ソフトウェアおよびボイスライブラリの利用規約（EULA）を遵守してご利用ください。
This bot is an unofficial tool and is not affiliated with AI, Inc. or VOICEVOX.