# TTS Discord Bot (A.I.VOICE & VOICEVOX + LLM)

**A.I.VOICE Editor** および **VOICEVOX** と連携し、感情豊かな音声読み上げを提供する高機能 Discord Bot です。
バックエンドに **Rust** を採用することで、Python 単独では難しい高速な音声信号処理（トリミング、リバーブ、ミキシング）を実現しています。
また、**Pydantic** による堅牢なデータ検証と、ディレクトリベースの柔軟なキャラクター管理システムを備えています。

---

## 主な特徴

### 1. ハイブリッド TTS エンジン
状況や好みに応じて、2つの主要な音声合成エンジンを切り替えて運用可能です。
* **A.I.VOICE (Editor連携)**: 起動中の Editor を直接制御。プリセット切り替えによる自然な感情表現が可能。
* **VOICEVOX (API連携)**: 高速なレスポンス。ピッチや抑揚パラメータを動的に操作して感情を表現。

### 2. Rust による高速オーディオ処理
音声加工のコアロジック（無音カット、ゲイン調整、リバーブ付加、PCM変換）を **Rust (`rust_core`)** で実装。
ディスク I/O を極限まで削減したオンメモリ処理パイプラインにより、低遅延かつ高負荷に強い配信を実現しています。

### 3. ディレクトリ型キャラクター管理システム
`characters/` フォルダ内で、キャラクターごとに人格（プロンプト）とセリフ設定（JSON）を管理できます。
* **人格設定**: LLM に与えるシステムプロンプト。
* **セリフ設定**: 起動・切断・時報などのシステム音声を、キャラクターごとの口調に上書き可能。

### 4. 堅牢な設計
* **Pydantic 採用**: 設定ファイルの読み込み時に厳密なバリデーションを行い、記述ミスによるクラッシュを未然に防ぎます。
* **非同期アーキテクチャ**: 重い処理をメインループから分離し、Bot の応答性を常に維持します。

### 5. AI 対話 & ユーティリティ
* **ローカル LLM 連携**: LM Studio 等と接続し、感情タグ付きの自然な会話が可能。
* **便利機能**: アラーム、タイマー、辞書登録、ダイスロール機能を標準搭載。

---

## 動作環境

* **OS**: Windows 10 / 11 (64bit)
* **Python**: 3.10 以上 (インストーラーが自動でバージョン管理を行います)
* **Rust**: 1.70 以上 (拡張モジュールのビルドに必要)
* **TTSソフトウェア**:
    * A.I.VOICE Editor (Ver.1 推奨 / Ver.2 も対応)
    * VOICEVOX

---

## 導入手順

### Step 1. Rust のインストール
本 Bot は Rust 拡張モジュールを使用するため、事前に Rust コンパイラが必要です。
1. [Rust 公式サイト](https://www.rust-lang.org/tools/install) にアクセスし、インストーラー (`rustup-init.exe`) をダウンロードしてください。
2. インストーラーを実行し、デフォルト設定 (1) でインストールを行ってください。
3. インストール完了後、必ずコマンドプロンプトやターミナルを再起動してください。

### Step 2. リポジトリのクローン
```bash
git clone https://github.com/Shise-mix/TTS-Discord-Bot.git
cd TTS-DiscordBot
```

### Step 3. インストール & ビルド
Rust の準備ができたら、以下の手順でセットアップを行ってください。

**【推奨】自動セットアップ**
同梱の **`install.bat`** をダブルクリックして実行してください。
以下の処理が全自動で行われます。
1.  高速パッケージマネージャ **`uv`** の自動インストール
2.  **Python 3.11** 仮想環境の作成（システム環境に依存しません）
3.  依存ライブラリのインストール
4.  Rust 拡張モジュール (`rust_core`) の最適化ビルド

### Step 4. 環境変数の設定 (.env)
`.env.example` をコピーして `.env` を作成し、必要な情報を記述します。

```properties
# Discord Bot トークン
DISCORD_TOKEN=your_token_here

# LLM 連携設定 (LM Studio 等)
LLM_API_KEY=lm-studio

# --- A.I.VOICE 設定 ---
AIVOICE_DLL_PATH=C:\Program Files\AI\AIVoice\AIVoiceEditor\AI.Talk.Editor.Api.dll
# 自動起動用パス
AIVOICE_APP_PATH=C:\Program Files\AI\AIVoice\AIVoiceEditor\AIVoiceEditor.exe

# --- VOICEVOX 設定 ---
VOICEVOX_URL=http://127.0.0.1:50021
VOICEVOX_APP_PATH=C:\Users\Username\AppData\Local\Programs\VOICEVOX\VOICEVOX.exe
```

---

## キャラクター設定ガイド

`characters` フォルダ配下にサブフォルダを作成することで、新しいキャラクターを追加できます。

**構成例:**
```text
characters/
  ├─ akari/              <-- 任意のフォルダ名
  │   ├─ prompt.txt      <-- 人格プロンプト (ファイル名自由)
  │   └─ responses.json  <-- セリフ設定 (ファイル名自由)
  └─ zundamon/
      └─ ...
```

### 1. プロンプトファイル (*.txt)
LLM に対する役割（ロール）定義を記述します。
```text
命令：あなたは紲星あかりです。
明るく元気な後輩として振る舞ってください。
語尾：「〜だよ」「〜だね」
```

### 2. レスポンスファイル (*.json)
Bot のシステムメッセージをカスタマイズします。未定義の項目はデフォルト値が使用されます。
利用可能なキーは `models.py` または `DEFAULT_RESPONSES` を参照してください。

```json
{
    "join_greet_first": [
        "やっほー！待ってたよ！[JOY]",
        "遅いよー！[ANGRY]"
    ],
    "alarm_notify_voice": [
        "時間だよー！起きてー！[JOY]"
    ]
}
```

---

## エンジンの事前準備

### A.I.VOICE の場合
感情表現を有効にするため、Editor 上で以下の命名規則に従ってプリセットを作成してください。
Bot はこのサフィックスを見て感情を切り替えます。

| 感情タグ | プリセット名 (例: 紲星 あかり) | パラメータの目安 |
|---|---|---|
| **[NORMAL]** | `紲星 あかり_NORMAL` | 標準 |
| **[JOY]** | `紲星 あかり_JOY` | 抑揚高め、速度やや速め |
| **[SAD]** | `紲星 あかり_SAD` | 抑揚低め、速度遅め |
| **[ANGRY]** | `紲星 あかり_ANGRY` | 音量大きめ、速度速め |
| **[SURPRISE]** | `紲星 あかり_SURPRISE` | 語尾上がり |

### VOICEVOX の場合
事前のプリセット作成は不要です。
起動ウィザードにて、キャラクターとスタイル（ノーマル、あまあま等）を選択するだけで使用可能です。

---

## 使用方法

### 1. 起動
`start.bat` を実行すると、対話型のセットアップウィザードが起動します。
1.  **エンジンの選択** (A.I.VOICE / VOICEVOX)
2.  **キャラクターの選択** (エンジンから取得した一覧より選択)
3.  **人格設定のロード** (`characters` フォルダより選択)

### 2. コマンド一覧

| コマンド | 説明 |
|---|---|
| `/join` | Bot を VC に参加させます (移動も可能) |
| `/bye` | Bot を切断します |
| `/char [名前]` | 音声キャラクターを動的に変更します |
| `/presets` | 利用可能なプリセット一覧を表示します |
| `/stop` | 読み上げを即座に停止し、キューをクリアします |
| `/alarm add` | アラームを設定します |
| `/timer set` | タイマーを設定します |
| `/dict add` | 辞書登録を行います |
| `/dice` | ダイスロール (例: `2d6+3`) |
| `/reset` | LLM との会話履歴をリセットします |

### 3. 会話機能 (LLM)
Bot に対して **メンション** または **返信** を行うことで会話が可能です。
Bot は文脈から感情を推論し、自動的に声色（プリセット）を変更して応答します。

---

### アーキテクチャ概要
* **`main.py`**: エントリーポイント。起動ウィザードと設定ロードを担当。
* **`cogs/audio.py`**: 音声管理の中枢。Rust 拡張との連携、キュー処理、非同期再生制御。
* **`cogs/chat.py`**: LLM との通信、感情タグの解析。
* **`rust_core/`**: Rust による音声信号処理ライブラリ。

---

## ライセンス

MIT License

※ 本ソフトウェアは非公式ツールです。株式会社AI および VOICEVOX とは一切関係ありません。
各音声合成エンジンの利用規約（EULA）およびキャラクター利用ガイドラインを遵守してご利用ください。